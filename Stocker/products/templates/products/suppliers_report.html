{% extends "main/base.html" %}
{% load static %}

{% block title %}Supplier Report{% endblock %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v6.0.0-beta1/css/all.css">

<style>
  @media print {
    .no-print { display: none !important; }
    a[href]:after { content: ""; }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .card { box-shadow: none !important; }
  }
  .rounded-4 { border-radius: 1rem; }
</style>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="fw-bold mb-0">{{ report_title }}</h1>
      <div class="text-muted small">Generated: {{ generated_at|date:"F j, Y, g:i a" }}</div>
    </div>
    <div class="no-print d-flex gap-2">
      <button onclick="window.print()" class="btn btn-warning fw-bold">
        <i class="fa-thin fa-print"></i> Print
      </button>
    </div>
  </div>

  <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-4 mb-4">
    <div class="col">
      <div class="card h-100 text-white bg-success rounded-4 border-0 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-uppercase small fw-semibold opacity-75">Suppliers</div>
            <div class="display-5 fw-bold mb-0">{{ total_suppliers }}</div>
          </div>
          <div class="fs-1 opacity-75"><i class="fa-thin fa-truck-field"></i></div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100 text-white bg-primary rounded-4 border-0 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-uppercase small fw-semibold opacity-75">Products (All)</div>
            <div class="display-5 fw-bold mb-0">{{ total_products }}</div>
          </div>
          <div class="fs-1 opacity-75"><i class="fa-thin fa-boxes-stacked"></i></div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100 text-white bg-dark rounded-4 border-0 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-uppercase small fw-semibold opacity-75">Stock Value</div>
            <div class="display-6 fw-bold mb-0">{{ total_stock_value|floatformat:2 }} SAR</div>
          </div>
          <div class="fs-1 opacity-75"><i class="fa-thin fa-sack-dollar"></i></div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100 text-white bg-danger rounded-4 border-0 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-uppercase small fw-semibold opacity-75">Low Stock &lt; {{ low_stock_threshold }}</div>
            <div class="display-5 fw-bold mb-0">
              {{ suppliers|dictsort:"name"|length }} <!-- placeholder; see table below -->
            </div>
          </div>
          <div class="fs-1 opacity-75"><i class="fa-thin fa-triangle-exclamation"></i></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-body">
      <h4 class="fw-bold text-warning mb-3">Supplier Summary</h4>
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Supplier</th>
              <th class="text-center"># Products</th>
              <th class="text-center">Total Qty</th>
              <th class="text-end">Stock Value (SAR)</th>
              <th class="text-center">Low-Stock Items</th>
            </tr>
          </thead>
          <tbody>
            {% for s in suppliers %}
              <tr class="{% if s.low_stock_items %}table-warning{% endif %}">
                <td>{{ s.name }}</td>
                <td class="text-center">{{ s.num_products|default:0 }}</td>
                <td class="text-center">{{ s.total_quantity|default:0 }}</td>
                <td class="text-end">{{ s.total_stock_value|default:0|floatformat:2 }}</td>
                <td class="text-center">{{ s.low_stock_items|default:0 }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-center text-muted">No suppliers</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="small text-muted mt-2">
        Rows highlighted indicate suppliers with at least one product below {{ low_stock_threshold }} units.
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-4">
    <div class="card-body">
      <h4 class="fw-bold text-warning mb-3">Products by Supplier</h4>

      {% for s in suppliers %}
        <h5 class="mb-3">{{ s.name }}</h5>
        <div class="table-responsive mb-4">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Product</th>
                <th>Category</th>
                <th class="text-end">Price (SAR)</th>
                <th class="text-center">Qty</th>
                <th class="text-end">Stock Value (SAR)</th>
                <th class="text-nowrap">Updated</th>
              </tr>
            </thead>
            <tbody>
              {% for p in s.products.all %}
                <tr class="{% if p.quantity < low_stock_threshold %}table-danger{% endif %}">
                  <td>{{ forloop.counter }}</td>
                  <td>{{ p.name }}</td>
                  <td>{% if p.category %}{{ p.category.name }}{% else %}â€”{% endif %}</td>
                  <td class="text-end">{{ p.price|floatformat:2 }}</td>
                  <td class="text-center fw-semibold">{{ p.quantity }}</td>
                  <td class="text-end">{{ p.price|floatformat:2|add:"0"|floatformat:2|floatformat }}{% comment %}placeholder{% endcomment %}</td>
                  <td class="text-nowrap">{{ p.updated_at|date:"Y-m-d H:i" }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="7" class="text-center text-muted">No products</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% empty %}
        <div class="text-muted">No suppliers available.</div>
      {% endfor %}
    </div>
  </div>

  <div class="no-print text-center my-4">
    <button onclick="window.print()" class="btn btn-warning fw-bold px-4">
      <i class="fa-thin fa-print"></i> Print Report
    </button>
  </div>
</div>
{% endblock %}
